%D \module
%D   [       file=m-r,
%D        version=2006.06.06,
%D          title=\CONTEXT\ Modules,
%D       subtitle=R Support,
%D         author={Johan Sandblom \& Hans Hagen},
%D           date=\currentdate,
%D      copyright={PRAGMA / Johan Sandblom}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

\unprotect

%D The following R-processor is a variation on Johan Sandblom's
%D prototype.
%D
%D We can combine both variants in one macro definition. Also, we
%D can minimize the number of runs by checking for a change.

%D \starttyping
%D \newcounter\Rnumber
%D \newtoks\everyR
%D
%D \appendtoks
%D   \obeylines
%D \to \everyR
%D
%D \def\startR      {\dostartR\stopR      \plusone}
%D \def\startRhidden{\dostartR\stopRhidden\zerocount}
%D
%D \def\dostartR#1#2%
%D   {\bgroup
%D    \ifcase#2\relax\let\typeRout\relax\fi
%D    \obeylines
%D    \catcode`\%=\@@letter
%D    \catcode`\#=\@@letter
%D    \def\dostartR##1#1%
%D      {\doglobal\increment\Rnumber
%D       \edef\Rfile{\bufferprefix R-\Rnumber}%
%D       \bgroup
%D       \the\everyR
%D       \def\par{\rawcharacter{10}}%
%D       \immediate\openout\scratchwrite=\Rfile.r
%D       \immediate\write\scratchwrite{##1}%
%D       \immediate\closeout\scratchwrite
%D       \egroup
%D       \doifmode{*\v!first}\runR
%D       \typefile{\Rfile.rout}%
%D       \egroup}%
%D    \doifnextcharelse\relax\dostartR\dostartR}
%D
%D \def\runR
%D   {\executesystemcommand{texmfstart
%D      --ifchanged=\Rfile.r bin:R
%D      "-q --save --restore < \Rfile.r > \Rfile.rout"}}
%D \stoptyping

%D JS: The call to R has \type {-q} in order to prevent banner,
%D \type {--save} to make sure it saves the workspace after the run,
%D \type {--restore} to make sure it reads any workspace from a
%D previous session.

%D An easier and better solution is to use the buffering mechanisms:

\def\Rbufferprefix{r-}
\newcounter\nofRfiles

\def\Rfile{\TEXbufferfile{\Rbufferprefix\nofRfiles}}%

\def\startR
  {\doglobal\increment\nofRfiles
   \dostartbuffer[\Rbufferprefix\nofRfiles][startR][stopR]}

\def\stopR
  {\doifmode{*\v!first}\runR
   \typefile{\Rfile.out}}

\def\startRhidden
  {\doglobal\increment\nofRfiles
   \dostartbuffer[\Rbufferprefix\nofRfiles][startRhidden][stopRhidden]}

\def\stopRhidden
  {\doifmode{*\v!first}\runR}

\def\runR
  {\executesystemcommand{texmfstart
%         --ifchanged=\Rfile\space bin:R
      --ifchanged=\Rfile\space --direct R
      "-q --save --restore < \Rfile\space > \Rfile.out"}}

\protect \doifnotmode{demo}{\endinput}

% Johan's test file:

\starttext

\startR
a <- "bla"
b <- "blabla"
ls()
\stopR

bla bla

\startRhidden
rm(list=ls())
save.image()
\stopRhidden

more bla

\startR
ls()
ushape <- c(rexp(500000), 12-rexp(500000))
pdf("ushape.pdf")
par(mfrow=c(1,2))
hist(ushape)
plot(density(ushape), main="Density")
dev.off()
\stopR

\input tufte \par \input knuth

\startR
x <- rnorm(900)
y <- rexp(900)
# test comment
f <- gl(9,9,900)
summary(aov(y~x+Error(f)))
library(lattice)
pdf("lattice.pdf")
xyplot(y~x|f)
dev.off()
\stopR

\placefigure{}{\externalfigure[lattice]}
\placefigure{}{\externalfigure[ushape]}

\input tufte

\startR
(test <- ".*\\\\ []{}=?!+%#|<|>@$")
cat(test)
\stopR

\input bryson \par \input knuth

\startR
a.df <- data.frame(a=1:2, b=rnorm(2))
a.df$a
testfunction <- function(a=NULL, ...) {
  for(i in 1:length(a)) {
    gsub(a[[i]], "([a-r]|[A-R])", "bla")}
  print(a)}
\stopR

\stoptext
